# Bilibiliç®€åŒ–ä»»åŠ¡åˆ†å‘ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

ä¸ºbilibiliæ¨¡å—è®¾è®¡ä¸€ä¸ªç®€å•çš„ä»»åŠ¡åˆ†å‘æœºåˆ¶ï¼ŒåŒ…å«URLè·å–å’Œè§†é¢‘ä¸‹è½½ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ“‹ éœ€æ±‚åˆ†æ

### æ ¸å¿ƒåŠŸèƒ½
1. **URL Fetcher**ï¼šè·å–bilibiliè§†é¢‘URLï¼Œæ’å…¥ä»»åŠ¡è¡¨
2. **Video Fetcher**ï¼šä»ä»»åŠ¡è¡¨è·å–å¾…ä¸‹è½½ä»»åŠ¡ï¼Œæ‰§è¡Œè§†é¢‘ä¸‹è½½

### å·¥ä½œæµç¨‹
```
URL Fetcher â†’ æ’å…¥ä»»åŠ¡è¡¨ â†’ Video Fetcher â†’ ä¸‹è½½è§†é¢‘ â†’ æ›´æ–°çŠ¶æ€
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Bilibiliç®€åŒ–ä»»åŠ¡ç³»ç»Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ URL Fetcher â”‚              â”‚Video Fetcherâ”‚              â”‚
â”‚  â”‚             â”‚              â”‚             â”‚              â”‚
â”‚  â”‚ â€¢ è·å–URL   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ è·å–ä»»åŠ¡  â”‚              â”‚
â”‚  â”‚ â€¢ è·å–æ ‡é¢˜  â”‚              â”‚ â€¢ ä¸‹è½½è§†é¢‘  â”‚              â”‚
â”‚  â”‚ â€¢ è·å–æ—¶é•¿  â”‚              â”‚ â€¢ æ›´æ–°çŠ¶æ€  â”‚              â”‚
â”‚  â”‚ â€¢ æ’å…¥ä»»åŠ¡  â”‚              â”‚ â€¢ è®°å½•æ—¥å¿—  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                           â”‚                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                       â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              PostgreSQL Database                       â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚ â”‚
â”‚  â”‚              â”‚   video_tasks   â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚                 â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ id            â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ url           â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ title         â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ duration      â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ status        â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ download_type â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ log           â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ created_at    â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ modified_at   â”‚                       â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ï¼švideo_tasks

```sql
CREATE TABLE video_tasks (
    id SERIAL PRIMARY KEY,
    url VARCHAR(500) NOT NULL UNIQUE,
    title VARCHAR(200),
    duration INTEGER,  -- è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
    status INTEGER DEFAULT 0,  -- 0:å¾…ä¸‹è½½, 1:ä¸‹è½½æˆåŠŸ, -1:ä¸‹è½½å¤±è´¥
    download_type INTEGER DEFAULT 0,  -- ä¸‹è½½æ–¹å¼ï¼š0,1,2,3ç­‰
    log TEXT,  -- ä¸‹è½½å¤‡æ³¨/æ—¥å¿—
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    modified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_video_tasks_status ON video_tasks(status);
CREATE INDEX idx_video_tasks_created_at ON video_tasks(created_at);
CREATE INDEX idx_video_tasks_url ON video_tasks(url);

-- åˆ›å»ºè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°modified_at
CREATE OR REPLACE FUNCTION update_modified_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.modified_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_video_tasks_modified_at 
    BEFORE UPDATE ON video_tasks 
    FOR EACH ROW EXECUTE FUNCTION update_modified_at_column();
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SERIAL | ä¸»é”®ï¼Œè‡ªå¢ID |
| url | VARCHAR(500) | bilibiliè§†é¢‘URLï¼Œå”¯ä¸€çº¦æŸ |
| title | VARCHAR(200) | è§†é¢‘æ ‡é¢˜ |
| duration | INTEGER | è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ |
| status | INTEGER | ä»»åŠ¡çŠ¶æ€ï¼š0=å¾…ä¸‹è½½ï¼Œ1=æˆåŠŸï¼Œ-1=å¤±è´¥ |
| download_type | INTEGER | ä¸‹è½½æ–¹å¼ï¼š0,1,2,3ç­‰ä¸åŒç­–ç•¥ |
| log | TEXT | ä¸‹è½½å¤‡æ³¨å’Œæ—¥å¿—ä¿¡æ¯ |
| created_at | TIMESTAMP | ä»»åŠ¡åˆ›å»ºæ—¶é—´ï¼ˆè‡ªåŠ¨ï¼‰ |
| modified_at | TIMESTAMP | çŠ¶æ€ä¿®æ”¹æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰ |

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. TaskHub (ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ) - å•ä¾‹æ¨¡å¼

```python
import psycopg2
import psycopg2.extras
from typing import Optional, Dict, List, Any
from datetime import datetime
import threading
from contextlib import contextmanager

class TaskHub:
    """ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ - å•ä¾‹æ¨¡å¼ç®¡ç†PostgreSQLè¿æ¥å’Œæ‰€æœ‰ä»»åŠ¡æ“ä½œ"""
    
    _instance = None
    _lock = threading.Lock()
    
    def __new__(cls):
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super(TaskHub, cls).__new__(cls)
        return cls._instance
    
    def __init__(self):
        if not hasattr(self, 'initialized'):
            self.db_config: Optional[Dict[str, Any]] = None
            self.initialized = False
    
    def initialize(self, db_config: Dict[str, Any]):
        """åˆå§‹åŒ–æ•°æ®åº“é…ç½®"""
        if not self.initialized:
            self.db_config = db_config
            self.initialized = True
    
    @contextmanager
    def get_connection(self):
        """è·å–æ•°æ®åº“è¿æ¥çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        conn = None
        try:
            conn = psycopg2.connect(
                host=self.db_config['host'],
                port=self.db_config['port'],
                database=self.db_config['database'],
                user=self.db_config['username'],
                password=self.db_config['password']
            )
            yield conn
        finally:
            if conn:
                conn.close()
    
    # ==================== ä»»åŠ¡æ³¨å†Œæ–¹æ³• ====================
    
    def register_task(self, url: str, title: str = None, duration: int = None) -> int:
        """æ³¨å†Œå•ä¸ªä»»åŠ¡åˆ°æ•°æ®åº“"""
        with self.get_connection() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    INSERT INTO video_tasks (url, title, duration, status, created_at, modified_at)
                    VALUES (%s, %s, %s, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                    RETURNING id
                """, (url, title, duration))
                task_id = cur.fetchone()[0]
                conn.commit()
                return task_id
    
    def batch_register_tasks(self, video_list: List[Dict[str, Any]]) -> List[int]:
        """æ‰¹é‡æ³¨å†Œä»»åŠ¡"""
        task_ids = []
        with self.get_connection() as conn:
            with conn.cursor() as cur:
                for video in video_list:
                    cur.execute("""
                        INSERT INTO video_tasks (url, title, duration, status, created_at, modified_at)
                        VALUES (%s, %s, %s, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                        ON CONFLICT (url) DO NOTHING
                        RETURNING id
                    """, (video.get('url'), video.get('title'), video.get('duration')))
                    result = cur.fetchone()
                    if result:
                        task_ids.append(result[0])
                conn.commit()
        return task_ids
    
    # ==================== ä»»åŠ¡æå–æ–¹æ³• ====================
    
    def get_pending_tasks(self, limit: int = 10) -> List[Dict[str, Any]]:
        """è·å–å¾…å¤„ç†ä»»åŠ¡ï¼ˆstatus=0ï¼‰"""
        with self.get_connection() as conn:
            with conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor) as cur:
                cur.execute("""
                    SELECT id, url, title, duration, status, download_type, log, created_at, modified_at
                    FROM video_tasks 
                    WHERE status = 0 
                    ORDER BY created_at ASC 
                    LIMIT %s
                """, (limit,))
                return [dict(row) for row in cur.fetchall()]
    
    def get_task_by_id(self, task_id: int) -> Optional[Dict[str, Any]]:
        """æ ¹æ®IDè·å–ä»»åŠ¡è¯¦æƒ…"""
        with self.get_connection() as conn:
            with conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor) as cur:
                cur.execute("""
                    SELECT id, url, title, duration, status, download_type, log, created_at, modified_at
                    FROM video_tasks 
                    WHERE id = %s
                """, (task_id,))
                row = cur.fetchone()
                return dict(row) if row else None
    
    def get_tasks_by_status(self, status: int, limit: int = 100) -> List[Dict[str, Any]]:
        """æ ¹æ®çŠ¶æ€è·å–ä»»åŠ¡åˆ—è¡¨"""
        with self.get_connection() as conn:
            with conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor) as cur:
                cur.execute("""
                    SELECT id, url, title, duration, status, download_type, log, created_at, modified_at
                    FROM video_tasks 
                    WHERE status = %s 
                    ORDER BY created_at DESC 
                    LIMIT %s
                """, (status, limit))
                return [dict(row) for row in cur.fetchall()]
    
    # ==================== ä»»åŠ¡çŠ¶æ€æ›´æ–°æ–¹æ³• ====================
    
    def update_task_status(self, task_id: int, status: int, 
                          download_type: int = None, log: str = None) -> bool:
        """æ›´æ–°ä»»åŠ¡çŠ¶æ€"""
        with self.get_connection() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    UPDATE video_tasks 
                    SET status = %s, 
                        download_type = COALESCE(%s, download_type),
                        log = COALESCE(%s, log),
                        modified_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                """, (status, download_type, log, task_id))
                success = cur.rowcount == 1
                conn.commit()
                return success
    
    def mark_task_success(self, task_id: int, download_type: int = 0, log: str = "ä¸‹è½½æˆåŠŸ") -> bool:
        """æ ‡è®°ä»»åŠ¡ä¸ºæˆåŠŸçŠ¶æ€"""
        return self.update_task_status(task_id, 1, download_type, log)
    
    def mark_task_failed(self, task_id: int, error_log: str) -> bool:
        """æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥çŠ¶æ€"""
        return self.update_task_status(task_id, -1, None, error_log)
    
    # ==================== ç»Ÿè®¡å’ŒæŸ¥è¯¢æ–¹æ³• ====================
    
    def get_task_statistics(self) -> Dict[str, int]:
        """è·å–ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯"""
        with self.get_connection() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT 
                        COUNT(*) as total,
                        COUNT(CASE WHEN status = 0 THEN 1 END) as pending,
                        COUNT(CASE WHEN status = 1 THEN 1 END) as success,
                        COUNT(CASE WHEN status = -1 THEN 1 END) as failed
                    FROM video_tasks
                """)
                row = cur.fetchone()
                return {
                    'total': row[0],
                    'pending': row[1], 
                    'success': row[2],
                    'failed': row[3]
                }
    
    def cleanup_old_tasks(self, days: int = 30) -> int:
        """æ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„å·²å®Œæˆä»»åŠ¡"""
        with self.get_connection() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    DELETE FROM video_tasks 
                    WHERE status IN (1, -1) 
                    AND created_at < CURRENT_TIMESTAMP - INTERVAL '%s days'
                """, (days,))
                deleted_count = cur.rowcount
                conn.commit()
                return deleted_count
```

## ğŸ“ å®ç°è®¡åˆ’

### Phase 1: æ•°æ®åº“è®¾ç½® (1å¤©)
- [ ] åˆ›å»ºPostgreSQLæ•°æ®åº“è¡¨
- [ ] è®¾ç½®æ•°æ®åº“è¿æ¥é…ç½®
- [ ] ç¼–å†™æ•°æ®åº“æ“ä½œåŸºç¡€ç±»

### Phase 2: URL Fetcherå®ç° (2å¤©)
- [ ] å®ç°bilibili URLè§£æ
- [ ] å®ç°è§†é¢‘ä¿¡æ¯è·å–
- [ ] å®ç°ä»»åŠ¡æ’å…¥åŠŸèƒ½
- [ ] æ·»åŠ æ‰¹é‡å¤„ç†æ”¯æŒ

### Phase 3: Video Fetcherå®ç° (2å¤©)
- [ ] å®ç°ä»»åŠ¡è·å–é€»è¾‘
- [ ] å®ç°è§†é¢‘ä¸‹è½½åŠŸèƒ½
- [ ] å®ç°çŠ¶æ€æ›´æ–°æœºåˆ¶
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•

### Phase 4: æµ‹è¯•å’Œä¼˜åŒ– (1å¤©)
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ–
```python
# æ•°æ®åº“
psycopg2-binary>=2.9.0   # PostgreSQLæ•°æ®åº“é©±åŠ¨

# ç½‘ç»œè¯·æ±‚
requests>=2.28.0         # HTTPè¯·æ±‚åº“

# é…ç½®å’Œæ—¥å¿—
loguru>=0.7.0            # æ—¥å¿—è®°å½•
```

### é…ç½®æ‰©å±•
```yaml
# configs.yaml æ–°å¢éƒ¨åˆ†
database:
  host: "localhost"
  port: 5432
  database: "bilibili_tasks"
  username: "postgres"
  password: "password"
  
bilibili:
  max_concurrent_downloads: 3
  retry_attempts: 3
  download_timeout: 300
```

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### 1. åˆå§‹åŒ–TaskHub

```python
from task_hub import TaskHub

def main():
    # è·å–TaskHubå•ä¾‹å®ä¾‹
    task_hub = TaskHub()
    
    # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    db_config = {
        'host': 'localhost',
        'port': 5432,
        'database': 'bilibili_tasks',
        'username': 'postgres',
        'password': 'password'
    }
    
    task_hub.initialize(db_config)

if __name__ == "__main__":
    main()
```

### 2. ç›´æ¥ä½¿ç”¨TaskHubè¿›è¡Œä»»åŠ¡ç®¡ç†

```python
def task_management_example():
    # è·å–TaskHubå®ä¾‹ï¼ˆå•ä¾‹ï¼‰
    task_hub = TaskHub()
    
    # æ³¨å†Œä»»åŠ¡
    task_id = task_hub.register_task(
        url="https://www.bilibili.com/video/BV1234567890",
        title="æµ‹è¯•è§†é¢‘",
        duration=300
    )
    
    # è·å–å¾…å¤„ç†ä»»åŠ¡
    pending_tasks = task_hub.get_pending_tasks(limit=5)
    print(f"å¾…å¤„ç†ä»»åŠ¡æ•°é‡: {len(pending_tasks)}")
    
    # æ›´æ–°ä»»åŠ¡çŠ¶æ€
    success = task_hub.mark_task_success(task_id, download_type=0, log="ä¸‹è½½å®Œæˆ")
    print(f"ä»»åŠ¡çŠ¶æ€æ›´æ–°: {'æˆåŠŸ' if success else 'å¤±è´¥'}")
    
    # è·å–ç»Ÿè®¡ä¿¡æ¯
    stats = task_hub.get_task_statistics()
    print(f"ä»»åŠ¡ç»Ÿè®¡: {stats}")
    
    # æ¸…ç†æ—§ä»»åŠ¡
    cleaned = task_hub.cleanup_old_tasks(days=7)
    print(f"æ¸…ç†äº† {cleaned} ä¸ªæ—§ä»»åŠ¡")
```

## ğŸ¯ é¢„æœŸæˆæœ

1. **ç®€å•é«˜æ•ˆ**ï¼šåªæœ‰ä¸€å¼ è¡¨ï¼Œé€»è¾‘æ¸…æ™°
2. **è‡ªåŠ¨åŒ–**ï¼šæ—¶é—´æˆ³è‡ªåŠ¨ç®¡ç†ï¼ŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°
3. **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§ä¸‹è½½æ–¹å¼å’ŒçŠ¶æ€
4. **æ˜“ç»´æŠ¤**ï¼šä»£ç ç»“æ„ç®€å•ï¼Œä¾¿äºè°ƒè¯•
5. **é«˜æ€§èƒ½**ï¼šå¼‚æ­¥å¤„ç†ï¼Œæ”¯æŒå¹¶å‘ä¸‹è½½